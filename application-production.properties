# ═══════════════════════════════════════════════════════════════════════════
# SAKTI TX - PRODUCTION CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
# Use: java -jar app.jar --spring.profiles.active=production
# ═══════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════
# DRAGONFLY - PRODUCTION (HIGH DURABILITY)
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.dragonfly.enabled=true
sakti.tx.dragonfly.url=redis://dragonfly-ha.sakti.svc.cluster.local:6379
sakti.tx.dragonfly.password=${DRAGONFLY_PASSWORD}
sakti.tx.dragonfly.verify-durability=true

# WAIT FOR SYNC - MAXIMUM DURABILITY
# Trade-off: +5-10ms latency per transaction
# Guarantee: Transaction log synced to disk before proceeding
sakti.tx.dragonfly.wait-for-sync=true
sakti.tx.dragonfly.wait-for-sync-timeout-ms=5000

# Connection pool - tuned for production
sakti.tx.dragonfly.pool.size=128
sakti.tx.dragonfly.pool.min-idle=32

# ═══════════════════════════════════════════════════════════════════════════
# DISTRIBUTED TRANSACTION - PRODUCTION SETTINGS
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.multi-db.enabled=true
sakti.tx.multi-db.rollback-strategy=COMPENSATING
sakti.tx.multi-db.log-retention-hours=168  # 7 days

# Rollback retry - aggressive for production
sakti.tx.multi-db.max-rollback-retries=5
sakti.tx.multi-db.retry-backoff-ms=2000  # 2s, 4s, 8s, 16s, 32s

# ═══════════════════════════════════════════════════════════════════════════
# RECOVERY WORKER - PRODUCTION (MANDATORY LOCK)
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.multi-db.recovery.enabled=true
sakti.tx.multi-db.recovery.scan-interval-ms=300000      # 5 minutes
sakti.tx.multi-db.recovery.stall-timeout-ms=600000      # 10 minutes
sakti.tx.multi-db.recovery.max-recovery-attempts=5

# MANDATORY: Distributed lock required for K8s multi-pod deployment
sakti.tx.multi-db.recovery.require-distributed-lock=true

# ═══════════════════════════════════════════════════════════════════════════
# DISTRIBUTED LOCK - MANDATORY FOR PRODUCTION
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.lock.enabled=true
sakti.tx.lock.prefix=sakti:lock:
sakti.tx.lock.wait-time-ms=10000   # Wait up to 10s
sakti.tx.lock.lease-time-ms=60000  # Hold lock for max 60s

# ═══════════════════════════════════════════════════════════════════════════
# IDEMPOTENCY - MANDATORY FOR FINANCIAL OPERATIONS
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.idempotency.enabled=true
sakti.tx.idempotency.prefix=sakti:idemp:
sakti.tx.idempotency.ttl-seconds=14400  # 4 hours

# ═══════════════════════════════════════════════════════════════════════════
# CACHE - ENABLED FOR PERFORMANCE
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.cache.enabled=true
sakti.tx.cache.prefix=sakti:cache:
sakti.tx.cache.default-ttl-seconds=1800  # 30 minutes
sakti.tx.cache.max-entries=50000

# ═══════════════════════════════════════════════════════════════════════════
# CIRCUIT BREAKER - PREVENT COMPENSATION STORMS
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.circuit-breaker.enabled=true
sakti.tx.circuit-breaker.failure-threshold=5
sakti.tx.circuit-breaker.recovery-timeout-ms=60000

# Compensation circuit breaker
sakti.tx.circuit-breaker.compensation-failure-threshold=3
sakti.tx.circuit-breaker.compensation-recovery-window-ms=120000  # 2 minutes

# ═══════════════════════════════════════════════════════════════════════════
# VALIDATION - STRICT MODE FOR PRODUCTION
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.validation.enabled=true
sakti.tx.validation.long-running-threshold-ms=30000

# STRICT VERSION CHECK - RECOMMENDED FOR FINANCIAL SYSTEMS
# Version mismatch = IMMEDIATE FAIL (no compensation attempt)
sakti.tx.validation.strict-version-check=true

# Smart snapshot - exclude @Lob fields
sakti.tx.validation.smart-snapshot=true
sakti.tx.validation.max-string-length=10000

# Risk thresholds
sakti.tx.validation.max-risk-score=50
sakti.tx.validation.fail-on-critical-risk=true

# ═══════════════════════════════════════════════════════════════════════════
# OBSERVABILITY - FULL MONITORING
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.observability.metrics-enabled=true
sakti.tx.observability.tracing-enabled=false  # TODO: Enable when OpenTelemetry added
sakti.tx.observability.tracing-service-name=sakti-tx-prod

# ═══════════════════════════════════════════════════════════════════════════
# HEALTH CHECK
# ═══════════════════════════════════════════════════════════════════════════
sakti.tx.health.enabled=true

# ═══════════════════════════════════════════════════════════════════════════
# ADMIN API - ENABLED WITH SECURITY WARNING
# ═══════════════════════════════════════════════════════════════════════════
# ⚠️ WARNING: Secure these endpoints with Spring Security!
sakti.tx.multi-db.admin-api.enabled=true

# ═══════════════════════════════════════════════════════════════════════════
# SPRING ACTUATOR - PROMETHEUS METRICS
# ═══════════════════════════════════════════════════════════════════════════
management.endpoints.web.exposure.include=health,info,prometheus,metrics
management.endpoint.health.show-details=always
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true

# ═══════════════════════════════════════════════════════════════════════════
# LOGGING - PRODUCTION LEVEL
# ═══════════════════════════════════════════════════════════════════════════
logging.level.root=WARN
logging.level.id.go.kemenkeu.djpbn.sakti.tx=INFO

# Detailed logging for failures
logging.level.id.go.kemenkeu.djpbn.sakti.tx.core.compensate=DEBUG
logging.level.id.go.kemenkeu.djpbn.sakti.tx.starter.worker=DEBUG

# Log to file
logging.file.name=/var/log/sakti-tx/application.log
logging.file.max-size=100MB
logging.file.max-history=30

# ═══════════════════════════════════════════════════════════════════════════
# RECOMMENDED: GRAFANA DASHBOARD
# ═══════════════════════════════════════════════════════════════════════════
# Import dashboard: dashboards/sakti-tx-dashboard.json
# Metrics available at: /actuator/prometheus
#
# Key metrics to monitor:
# - sakti_tx_total{status="failed"}                  → Alert if > 0
# - sakti_tx_success_rate                            → Alert if < 95%
# - sakti_tx_compensation_success_rate               → Alert if < 90%
# - sakti_tx_risk_flags_total{risk="TRIGGER"}        → Warning threshold
# - sakti_tx_duration_max_ms                         → Alert if > 60000
#
# Recommended alerts:
# 1. Failed transactions > 5 in 5 minutes
# 2. Success rate < 95% for 10 minutes
# 3. Compensation failures > 3 in 1 hour
# 4. Circuit breaker open
# 5. Recovery worker stalled